
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Upgrading Applications Without Loss of Availability</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/style.css" rel="stylesheet">
    <script src="https://use.fontawesome.com/96c4d89611.js"></script>
  </head>
  <body>
<table id="doc-title" cellspacing="0" cellpadding="0">
  <tr>
  <td align="left" valign="top">
  <b>Upgrading Applications Without Loss of Availability</b><br />
      <p class="beta">DRAFT</p>
  </td>
  </tr>
</table>
<hr />

<table width="90%" id="top-nav" cellspacing="0" cellpadding="0">
	<colgroup>
		<col width="12%"/>
		<col width="12%"/>
		<col width="*"/>
	</colgroup>
	<tr>
		<td align="left">
		<a href="http-load-balancing.html">
			<span class="vector-font"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i></span>
			<span style="position:relative;top:-2px;">Previous</span>
		</a>
		</td>

		<td align="left">
		<a href="session-persistence-and-failover.html">
			<span class=" vector-font"><i class="fa fa-arrow-circle-right vector-font" aria-hidden="true"></i></span>
			<span style="position:relative;top:-2px;">Next</span>
		</a>
		</td>

		<td align="right">
		<a href="toc.html">
			<span class=" vector-font"><i class="fa fa-list vector-font" aria-hidden="true"></i></span>
			<span style="position:relative;top:-2px;">Contents</span>
		</a>
		</td>
	</tr>
</table>


<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a id="GSHAG00010"></a><a id="abdik"></a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="upgrading-applications-without-loss-of-availability">8 Upgrading Applications Without Loss of Availability</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Upgrading an application to a new version without loss of availability
to users is called a rolling upgrade. Carefully managing the two
versions of the application across the upgrade ensures that current
users of the application complete their tasks without interruption,
while new users transparently get the new version of the application.
With a rolling upgrade, users are unaware that the upgrade occurs.</p>
</div>
<div class="paragraph">
<p>For more information about application versions and how they are
identified, see "<a href="../application-deployment-guide/overview.html#GSDPG00324">Module and Application Versions</a>" in
GlassFish Server Open Source Edition Application Deployment Guide.</p>
</div>
<div class="paragraph">
<p>In a clustered environment, a rolling upgrade redeploys an application
with a minimal loss of service and sessions. A session is any artifact
that can be replicated, for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>HttpSession</code></p>
</li>
<li>
<p><code>SingleSignOn</code></p>
</li>
<li>
<p><code>ServletTimer</code></p>
</li>
<li>
<p><code>DialogFragment</code></p>
</li>
<li>
<p>Stateful session bean</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A rolling upgrade can take place under light to moderate loads. The
procedure requires about 10-15 minutes for each GlassFish Server
instance.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>Caution:</p>
</div>
<div class="paragraph">
<p>To prevent the risk of version mismatch when a session fails over,
upgrade all instances in a cluster at the same time. Otherwise a session
might fail over to an instance where different versions of components
are running.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Perform this task on each cluster separately. A cluster acts as a safe
boundary for session failover for instances in the cluster. Sessions in
one cluster can never fail over to sessions in another cluster.
Therefore, the risk of version mismatch is avoided.</p>
</div>
<div class="paragraph">
<p><a id="abdil"></a><a id="GSHAG00205"></a><a id="application-compatibility"></a></p>
</div>
<div class="sect2">
<h3 id="_application_compatibility">Application Compatibility</h3>
<div class="paragraph">
<p>Rolling upgrades pose varying degrees of difficulty depending on the
magnitude of changes between the two application versions.</p>
</div>
<div class="paragraph">
<p>If the changes are superficial, for example, changes to static text and
images, the two versions of the application are compatible and can both
run at once in the same cluster.</p>
</div>
<div class="paragraph">
<p>Compatible applications must:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the same session information</p>
</li>
<li>
<p>Use compatible database schemas</p>
</li>
<li>
<p>Have generally compatible application-level business logic</p>
</li>
<li>
<p>Use the same physical data source</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can perform a rolling upgrade of a compatible application in either
a single cluster or multiple clusters. For more information, see
<a href="#abdim">Upgrading In a Single Cluster</a>.</p>
</div>
<div class="paragraph">
<p>If the two versions of an application do not meet all the above
criteria, then the applications are considered incompatible. Executing
incompatible versions of an application in one cluster can corrupt
application data and cause session failover to not function correctly.
The problems depend on the type and extent of the incompatibility. It is
good practice to upgrade an incompatible application by creating a
"shadow cluster" to which to deploy the new version and slowly quiesce
the old cluster and application. For more information, see
<a href="#abdio">Upgrading Incompatible Applications</a>.</p>
</div>
<div class="paragraph">
<p>The application developer and administrator are the best people to
determine whether application versions are compatible. If in doubt,
assume that the versions are incompatible, since this is the safest
approach.</p>
</div>
<div class="paragraph">
<p><a id="abdim"></a><a id="GSHAG00206"></a><a id="upgrading-in-a-single-cluster"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_upgrading_in_a_single_cluster">Upgrading In a Single Cluster</h3>
<div class="paragraph">
<p>You can perform a rolling upgrade of an application deployed to a single
cluster, providing the cluster&#8217;s configuration is not shared with any
other cluster.</p>
</div>
<div class="paragraph">
<p><a id="fxxvd"></a><a id="GSHAG00151"></a><a id="to-upgrade-an-application-in-a-single-cluster"></a></p>
</div>
<div class="sect3">
<h4 id="_to_upgrade_an_application_in_a_single_cluster">To Upgrade an Application in a Single Cluster</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Deploy the upgraded application to the cluster in a disabled state
and with a new version identifier.<br>
For example:<br></p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>asadmin&gt; asadmin deploy --enabled=false --target myCluster myApp:1.1</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Perform the following steps for each server instance in the cluster.</p>
</li>
<li>
<p>Quiesce one server instance in the cluster from the load balancer.<br>
Follow these steps:</p>
</li>
<li>
<p>Disable the server instance using <code>asadmin disable-http-lb-server.</code></p>
</li>
<li>
<p>Export the load balancer configuration file using
<code>asadmin export-http-lb-config</code>.</p>
</li>
<li>
<p>Copy the exported configuration file to the web server instance&#8217;s
configuration directory.<br>
For example, for Sun Java System Web Server, the location is
web-server-install-dir`/``https-<code>host-name</code>/config/loadbalancer.xml`.</p>
</li>
<li>
<p>Wait until the timeout has expired.<br>
Monitor the load balancer&#8217;s log file.</p>
</li>
<li>
<p>Enable the upgraded application version on the quiesced server
instance.<br>
For example:<br></p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>asadmin&gt; asadmin enable --target instance01 myApp:1.1</pre>
</div>
</div>
<div class="paragraph">
<p>Enabling the upgraded application version automatically disables the
previous version.
3.  Test the upgraded application on the server instance to make sure it
runs correctly.
4.  Re-enable the server instance in load balancer.<br>
Follow these steps:
1.  Enable the server instance using <code>asadmin enable-http-lb-server.</code>
2.  Export the load balancer configuration file using
<code>asadmin export-http-lb-config</code>.
3.  Copy the configuration file to the web server&#8217;s configuration
directory.</p>
</div>
<div class="paragraph">
<p><a id="abdin"></a><a id="GSHAG00207"></a><a id="upgrading-in-multiple-clusters"></a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_upgrading_in_multiple_clusters">Upgrading in Multiple Clusters</h3>
<div class="paragraph">
<p><a id="fxxvb"></a><a id="GSHAG00152"></a><a id="to-upgrade-a-compatible-application-in-two-or-more-clusters"></a></p>
</div>
<div class="sect3">
<h4 id="_to_upgrade_a_compatible_application_in_two_or_more_clusters">To Upgrade a Compatible Application in Two or More Clusters</h4>
<div class="paragraph">
<p>Repeat the following procedure for each cluster.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Deploy the upgraded application to one cluster in a disabled state
and with a new version identifier.<br>
For example:<br></p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>asadmin&gt; asadmin deploy --enabled=false --target myCluster myApp:1.1</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Quiesce the cluster with the upgraded application from the load
balancer.</p>
</li>
<li>
<p>Disable the cluster using <code>asadmin disable-http-lb-server</code>.</p>
</li>
<li>
<p>Export the load balancer configuration file using
<code>asadmin export-http-lb-config</code>.</p>
</li>
<li>
<p>Copy the exported configuration file to the web server instance&#8217;s
configuration directory.<br>
For example, for Sun Java System Web Server, the location is
web-server-install-dir/<code>https-`host-name</code>/config/loadbalancer.xml`.</p>
</li>
<li>
<p>Wait until the timeout has expired.<br>
Monitor the load balancer&#8217;s log file.</p>
</li>
<li>
<p>Enable the upgraded application version on the quiesced cluster.<br>
For example:<br></p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>asadmin&gt; asadmin enable --target myCluster myApp:1.1</pre>
</div>
</div>
<div class="paragraph">
<p>Enabling the upgraded application version automatically disables the
previous version.
4.  Test the upgraded application on the cluster to make sure it runs
correctly.
5.  Enable the cluster in the load balancer:
1.  Enable the cluster using <code>asadmin enable-http-lb-server.</code>
2.  Export the load balancer configuration file using
<code>asadmin export-http-lb-config</code>.
3.  Copy the configuration file to the web server&#8217;s configuration
directory.</p>
</div>
<div class="paragraph">
<p><a id="abdio"></a><a id="GSHAG00208"></a><a id="upgrading-incompatible-applications"></a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_upgrading_incompatible_applications">Upgrading Incompatible Applications</h3>
<div class="paragraph">
<p>If the new version of the application is incompatible with the old
version, use the following procedure. For information on what makes
applications compatible, see <a href="#abdil">Application Compatibility</a>.
Also, you must upgrade incompatible application in two or more clusters.
If you have only one cluster, create a "shadow cluster" for the upgrade,
as described below.</p>
</div>
<div class="paragraph">
<p>When upgrading an incompatible application:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Give the new version of the application a different version identifier
from the old version of the application. The steps below assume that the
application has a new version identifier.</p>
</li>
<li>
<p>If the data schemas are incompatible, use different physical data
sources after planning for data migration.</p>
</li>
<li>
<p>Deploy the new version to a different cluster from the cluster where
the old version is deployed.</p>
</li>
<li>
<p>Set an appropriately long timeout for the cluster running the old
application before you take it offline, because the requests for the
application won&#8217;t fail over to the new cluster. These user sessions will
simply fail.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="abdip"></a><a id="GSHAG00153"></a><a id="to-upgrade-an-incompatible-application-by-creating-a-second-cluster"></a></p>
</div>
<div class="sect3">
<h4 id="_to_upgrade_an_incompatible_application_by_creating_a_second_cluster">To Upgrade an Incompatible Application by Creating a Second Cluster</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a "shadow cluster" on the same or a different set of machines
as the existing cluster. If you already have a second cluster, skip this
step.</p>
</li>
<li>
<p>Use the Administration Console to create the new cluster and
reference the existing cluster&#8217;s named configuration.<br>
Customize the ports for the new instances on each machine to avoid
conflict with existing active ports.</p>
</li>
<li>
<p>For all resources associated with the cluster, add a resource
reference to the newly created cluster using
<code>asadmin create-resource-ref</code>.</p>
</li>
<li>
<p>Create a reference to all other applications deployed to the cluster
(except the current upgraded application) from the newly created cluster
using <code>asadmin create-application-ref</code>.</p>
</li>
<li>
<p>Configure the cluster to be highly available using
<code>asadmin configure-ha-cluster</code>.</p>
</li>
<li>
<p>Create reference to the newly-created cluster in the load balancer
configuration file using <code>asadmin create-http-lb-ref.</code></p>
</li>
<li>
<p>Give the new version of the application a different version
identifier from the old version.</p>
</li>
<li>
<p>Deploy the new application version with the new cluster as the
target. Use a different context root or roots.</p>
</li>
<li>
<p>Start the new cluster while the other cluster is still running.<br>
The start causes the cluster to synchronize with the domain and be
updated with the new application.</p>
</li>
<li>
<p>Test the application on the new cluster to make sure it runs
correctly.</p>
</li>
<li>
<p>Disable the old cluster from the load balancer using
<code>asadmin disable-http-lb-server</code>.</p>
</li>
<li>
<p>Set a timeout for how long lingering sessions survive.</p>
</li>
<li>
<p>Enable the new cluster from the load balancer using
<code>asadmin enable-http-lb-server</code>.</p>
</li>
<li>
<p>Export the load balancer configuration file using
<code>asadmin export-http-lb-config</code>.</p>
</li>
<li>
<p>Copy the exported configuration file to the web server instance&#8217;s
configuration directory.<br>
For example, for Sun Java System Web Server, the location is
web-server-install-dir/<code>https-`host-name</code>/config/loadbalancer.xml`.</p>
</li>
<li>
<p>After the timeout period expires or after all users of the old
application have exited, stop the old cluster and undeploy the old
application version.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>

<hr />

<table width="90%" id="bottom-nav" cellspacing="0" cellpadding="0">
	<colgroup>
		<col width="12%"/>
		<col width="12%"/>
		<col width="*"/>
	</colgroup>
	<tr>		
		<td align="left">
		<a href="http-load-balancing.html">
			<span class=" vector-font"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i></span>
			<span style="position:relative;top:-2px;">Previous</span>
		</a>
		</td>

		<td align="left">
		<a href="session-persistence-and-failover.html">
			<span class="vector-font"><i class="fa fa-arrow-circle-right vector-font" aria-hidden="true"></i></span>
			<span style="position:relative;top:-2px;">Next</span>
		</a>
		</td>

		<td align="right">
		<a href="toc.html">
			<span class="vector-font"><i class="fa fa-list vector-font" aria-hidden="true"></i></span>
			<span style="position:relative;top:-2px;">Contents</span>
		</a>
		</td>
	</tr>
</table>

<span id="copyright">
        <img src="img/eclipse_foundation_logo_tiny.png" height="20px" alt="Eclipse Foundation Logo" align="top"/>&nbsp;            
        <span >Copyright&nbsp;&copy;&nbsp;2019,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.</span>
</span>

<p align="center" class="beta">DRAFT</p>

</body>
</html>